#!/bin/sh

BRANCH=$(git rev-parse --abbrev-ref HEAD)
PROTECTED_BRANCHES="^(main|preview)$"

if echo "$BRANCH" | grep -qE "$PROTECTED_BRANCHES"; then
  echo "Direct push to '$BRANCH' is not allowed."
  echo "Create a feature branch from 'main' and open a pull request instead."
  exit 1
fi

echo "Running tests with coverage..."
bun run test:coverage

if [ $? -ne 0 ]; then
  echo "Tests failed or coverage is below threshold. Push rejected."
  exit 1
fi
